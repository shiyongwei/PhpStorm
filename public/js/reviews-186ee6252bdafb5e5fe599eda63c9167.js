ER.require("ER.Reviews",function(){var t={},e=null,n=function(t){t=t||{},i(t),a(),r()};t.init=n;var i=function(t){e=t.container||$(document)},a=function(){$(".js-updateReviewTrigger").click(function(){$.ajax({url:ER.Layout.routes.my_review_path+".js",type:"get",dataType:"html",success:function(t){var e=$(t),n=!1;e.on("show",function(){if(!n){var t=e.find(".js-ratings");e.find(".js-ratingContainer").each(function(){var t=$(this),e=t.find(".js-rating"),n=t.find(".js-starRating"),i=n.val()||0;e.raty({half:!1,number:5,click:function(t){n.val(t)},score:i})}),e.find(".js-submitTrigger").click(function(n){n.preventDefault();var i=($(this),e.find("form")),a=!0;e.find(".js-ratingContainer").each(function(){var e=$(this),n=e.find(".js-starRating");return""==n.val()?(t.addClass("error"),a=!1,!1):void t.removeClass("error")}),a&&ER.Layout.authenticateAndPerform({beforeShow:function(){e.hide()},onSuccess:function(){var t=i.serializeArray();t.push({name:"authenticity_token",value:ER.Layout.authenticityToken}),$.ajax({type:"post",url:i.attr("action")+".js",data:t,success:function(){window.location.reload()},error:function(t){e.show();var n=JSON.parse(t.responseText);alert(406==t.status?n.errors.join():n.message)}})}})}),n=!0}}),ER.Layout.showOverlay(e)},error:function(t){var e=JSON.parse(t.responseText);alert(e.message)}})})},r=function(t){t||(t=e.find(".js-review")),t.each(function(){o($(this))})};t.initReviews=r;var o=function(t){t.find(".js-likeTrigger").click(function(){var t=$(this);ER.Layout.authenticateAndPerform({onSuccess:function(){var e=t.parents(".js-review");s(e,{authenticity_token:ER.Layout.authenticityToken},{onComplete:function(){"function"==typeof ER.Layout.getAuthenticationOverlay&&ER.Layout.getAuthenticationOverlay().close()}})}})}),t.find(".js-dislikeTrigger").click(function(){var t=$(this);ER.Layout.authenticateAndPerform({onSuccess:function(){var e=t.parents(".js-review");s(e,{authenticity_token:ER.Layout.authenticityToken,operation:"dislike"},{onComplete:function(){"function"==typeof ER.Layout.getAuthenticationOverlay&&ER.Layout.getAuthenticationOverlay().close()}})}})}),t.find(".js-rating").raty({readOnly:!0,half:!1,number:5,score:function(){return $(this).attr("data-score")}})},s=function(t,e,n){$.ajax({url:ER.Layout.routes.review_vote_path.replace(":id",t.attr("data-reviewId")),type:"post",data:e,dataType:"json",success:function(e){1==e.voted?t.find(".js-likeTrigger").addClass("active"):t.find(".js-likeTrigger").removeClass("active"),0==e.voted?t.find(".js-dislikeTrigger").addClass("active"):t.find(".js-dislikeTrigger").removeClass("active"),t.find(".js-rank").html(e.new_rank)},error:function(t){var e=JSON.parse(t);alert(e.message)},complete:function(){n.onComplete&&n.onComplete()}})};return t}());